<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Daily Stock Report</title>
    
    <link rel="icon" type="image/png" href="https://i.ibb.co/ynyfk7Dr/20250827-104636.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        pre {
            white-space: pre-wrap;
            word-wrap: break-word;
            line-height: 1.6;
            font-family: inherit;
        }
        pre.editable {
            background-color: #fffbeb;
            border: 2px dashed #f59e0b;
            padding: 10px;
            border-radius: 8px;
            outline: none;
        }
        .loader {
            border: 3px solid #f3f3f3; border-radius: 50%; border-top: 3px solid #4f46e5;
            width: 24px; height: 24px; animation: spin 1s linear infinite; margin: 0 auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="antialiased text-gray-800">

    <div class="container mx-auto max-w-3xl p-4 sm:p-6">
        
        <!-- Header -->
        <header class="text-center mb-4">
            <h1 class="text-2xl font-bold text-gray-900 flex items-center justify-center gap-2">
                Daily DTR Report
            </h1>
            <p id="date-display" class="text-sm text-gray-500 font-medium mt-1">...</p>
        </header>

        <!-- Error Box (Hidden by default) -->
        <div id="error-box" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4 text-sm font-bold text-center">
            <span id="error-msg">Something went wrong.</span>
        </div>

        <!-- Controls (Buttons Row) -->
        <div class="bg-white p-3 rounded-lg shadow-sm border border-gray-200 mb-4 flex flex-wrap justify-center gap-3 items-center">
            
            <!-- WhatsApp Button (Top & Small) -->
            <button id="whatsappShareBtn" class="bg-[#25D366] hover:bg-[#20bd5a] text-white font-bold py-1.5 px-3 rounded text-xs flex items-center gap-1 shadow-sm transition">
                <i class="ph-fill ph-whatsapp-logo text-base"></i>
                Share
            </button>

            <!-- Edit Button -->
            <button id="editBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-1.5 px-3 rounded text-xs flex items-center gap-1 shadow-sm transition">
                <i class="ph-bold ph-pencil-simple"></i> Edit
            </button>

            <!-- Reset Button -->
            <button id="resetBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-1.5 px-3 rounded text-xs flex items-center gap-1 shadow-sm transition">
                <i class="ph-bold ph-arrow-counter-clockwise"></i> Reset
            </button>
        </div>

        <div class="text-center mb-2">
             <span id="statusMsg" class="text-[10px] font-bold text-green-600"></span>
        </div>

        <!-- Main Report Area -->
        <main class="bg-white rounded-xl shadow-lg border border-gray-100 overflow-hidden relative min-h-[300px]">
            
            <!-- Loading Overlay -->
            <div id="loading-overlay" class="absolute inset-0 bg-white z-10 flex flex-col items-center justify-center">
                <div class="loader mb-2"></div>
                <p class="text-xs text-gray-500 font-bold">Connecting to Database...</p>
            </div>

            <!-- Content -->
            <div class="p-6 md:p-8">
                <pre id="reportContent" class="text-sm text-gray-800" contenteditable="false"></pre>
            </div>
        </main>

        <div class="text-center mt-4 text-xs text-gray-400">
            Auto-updates from database â€¢ Resets daily at 12:00 AM
        </div>
    </div>

    <!-- Firebase Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js";
        import { getAuth, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAgzs3GqaafEHQSnEyZqrjQT0r_6jXMaGQ",
            authDomain: "re-store-7f2b3.firebaseapp.com",
            databaseURL: "https://re-store-7f2b3-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "re-store-7f2b3",
            storageBucket: "re-store-7f2b3.appspot.com",
            messagingSenderId: "774895588253",
            appId: "1:774895588253:web:dad6c0fed92bce7c39574"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);

        // UI Elements
        const reportEl = document.getElementById('reportContent');
        const loadingOverlay = document.getElementById('loading-overlay');
        const dateDisplay = document.getElementById('date-display');
        const statusMsg = document.getElementById('statusMsg');
        const errorBox = document.getElementById('error-box');
        const errorMsg = document.getElementById('error-msg');

        const STORAGE_KEY = 'savedDTRContent';
        const DATE_KEY = 'savedDTRDate';

        // --- AUTHENTICATION ---
        // Using the credentials you provided in the first code
        signInWithEmailAndPassword(auth, "jackprince79036@gmail.com", "123456")
            .then((userCredential) => {
                console.log("Logged in:", userCredential.user.email);
                // Auth successful, data listener will trigger automatically
            })
            .catch((error) => {
                console.error("Login Failed:", error);
                showError(`Login Failed: ${error.message}. Check console.`);
                loadingOverlay.classList.add('hidden');
            });

        function showError(msg) {
            errorBox.classList.remove('hidden');
            errorMsg.innerText = msg;
        }

        // --- DATA PROCESSING ---
        function getPartyName(stackNum) {
            const s = parseInt(stackNum);
            if (isNaN(s)) return "Unknown";
            
            if (s === 501) return "IGNORE"; 
            
            if (s === 7) return "MONO ENTERPRISE";
            if (s >= 1 && s <= 18) return "ITC";
            if ([22, 23, 25, 26, 27].includes(s)) return "TYAGI KRISHI KENDRA";
            if ([24, 28, 29, 30, 103, 105, 106].includes(s)) return "ITC";
            if ([101, 102, 104].includes(s)) return "SHIVSHANKAR TRADING";
            
            return "GENERAL PARTY";
        }

        function generateReport(transactions) {
            const todayStr = new Date().toLocaleDateString('en-GB');
            dateDisplay.innerText = todayStr;

            if (!transactions) return "No transactions data received.";

            // Step A: Aggregate by Stack
            let stackData = {};
            let hasValidData = false;
            
            // Loop through transactions safely
            transactions.forEach(t => {
                if(!t) return;
                const s = parseInt(t.stackNumber);
                
                // Rule 1: Exclude 501
                if (isNaN(s) || s === 501) return;

                if (!stackData[s]) {
                    stackData[s] = { 
                        netBags: 0, netWeight: 0, 
                        commodity: t.commodity || 'Grain',
                        party: getPartyName(s)
                    };
                }

                // Parse numbers safely to avoid NaN
                const bags = Number(t.bags) || 0;
                const weight = Number(t.weight) || 0;

                if (t.transactionType === 'inward') {
                    stackData[s].netBags += bags;
                    stackData[s].netWeight += weight;
                } else {
                    stackData[s].netBags -= bags;
                    stackData[s].netWeight -= weight;
                }
                hasValidData = true;
            });

            if (!hasValidData) return "No valid stack data found (All excluded or empty).";

            // Step B: Group by Party
            let partyGroups = {};
            let grandTotalBags = 0;
            let grandTotalWeight = 0;

            Object.keys(stackData).forEach(stackNum => {
                const data = stackData[stackNum];
                
                // Fix floating point precision
                const cleanWeight = parseFloat(data.netWeight.toFixed(3));

                // Rule 2: Skip Nil/Negative Stock
                if (data.netBags <= 0 || cleanWeight <= 0.001) return;

                const p = data.party;
                if(p === "IGNORE") return;

                if (!partyGroups[p]) {
                    partyGroups[p] = { 
                        bags: 0, weight: 0, 
                        commodity: data.commodity 
                    };
                }

                partyGroups[p].bags += data.netBags;
                partyGroups[p].weight += cleanWeight;

                grandTotalBags += data.netBags;
                grandTotalWeight += cleanWeight;
            });

            // Step C: Build Text
            let reportText = "";
            const parties = Object.keys(partyGroups).sort();

            if (parties.length === 0) {
                return "All current stocks are 0 or NIL.";
            }

            parties.forEach(party => {
                const d = partyGroups[party];
                reportText += `ðŸ“¦ *STOCK SUMMARY:*
ðŸ“… Date: *${todayStr}*
ðŸ“ Subject: Daily Inward/Outward Report
ðŸ¢ *RUDRANSH WAREHOUSE BEGUSARAI*
ðŸ¤ Client: *${party}*
ðŸŒ¾ Commodity: *${d.commodity}*
ðŸ“¦ OPENING Bags :- *${d.bags}*
âš–ï¸ OPENING MT   :- *${d.weight.toFixed(3)}*
ðŸ“¥ INWARD Bags :-  *0*
âš–ï¸ INWARD MT    :-  *0*
ðŸ“¤ OUTWARD Bag:- *0*
âš–ï¸ OUTWARD MT :- *0*
ðŸ§µ MADE-UP Bag  :- *0*
ðŸ“¦ CLOSING Bag  :- *${d.bags}*
âš–ï¸ CLOSING MT :-  *${d.weight.toFixed(3)}*
ðŸ’° Funded Stock Details:
ðŸ“¦ Bags: 0
âš–ï¸ Quantity: 0
ðŸ¦ Bank: 0

----------------------------------------------------

`;
            });

            reportText += `ðŸ“Š *GRAND TOTAL SUMMARY*
ðŸ“¦ TOTAL Bags  :- *${grandTotalBags}*
âš–ï¸ TOTAL MT    :- *${grandTotalWeight.toFixed(3)}*`;

            return reportText;
        }

        // --- DATA FETCHING ---
        function loadData() {
            const today = new Date().toDateString();
            const savedDate = localStorage.getItem(DATE_KEY);

            // Auto-Reset Check (12:00 AM)
            if (savedDate && savedDate !== today) {
                localStorage.removeItem(STORAGE_KEY);
                localStorage.removeItem(DATE_KEY);
            }

            if (localStorage.getItem(STORAGE_KEY)) {
                reportEl.innerText = localStorage.getItem(STORAGE_KEY);
                dateDisplay.innerText = new Date().toLocaleDateString('en-GB');
                loadingOverlay.classList.add('hidden');
            } else {
                // Fetch new if no local save
                const txnRef = ref(db, 'transactions');
                loadingOverlay.classList.remove('hidden');

                onValue(txnRef, (snapshot) => {
                    loadingOverlay.classList.add('hidden');
                    const data = snapshot.val();
                    
                    if (data) {
                        try {
                            const transactions = Object.values(data);
                            const freshText = generateReport(transactions);
                            
                            // Only update if not currently editing/saved
                            if (!localStorage.getItem(STORAGE_KEY)) {
                                reportEl.innerText = freshText;
                            }
                            window.originalReportText = freshText;
                            
                            // Clear any previous errors
                            errorBox.classList.add('hidden');
                        } catch (err) {
                            showError("Error processing data: " + err.message);
                        }
                    } else {
                        reportEl.innerText = "Database is empty.";
                    }
                }, (error) => {
                    loadingOverlay.classList.add('hidden');
                    showError("Database Permission Denied. Check Login.");
                    console.error(error);
                });
            }
        }

        // --- BUTTON EVENTS ---
        const editBtn = document.getElementById('editBtn');
        editBtn.addEventListener('click', () => {
            const isEditable = reportEl.getAttribute('contenteditable') === 'true';
            if (isEditable) {
                reportEl.setAttribute('contenteditable', 'false');
                reportEl.classList.remove('editable');
                editBtn.innerHTML = '<i class="ph-bold ph-pencil-simple"></i> Edit';
                editBtn.classList.replace('bg-green-600', 'bg-indigo-600');
                statusMsg.innerText = "Saved Locally";
            } else {
                reportEl.setAttribute('contenteditable', 'true');
                reportEl.classList.add('editable');
                reportEl.focus();
                editBtn.innerHTML = '<i class="ph-bold ph-check"></i> Save';
                editBtn.classList.replace('bg-indigo-600', 'bg-green-600');
                statusMsg.innerText = "Editing...";
            }
        });

        // Typing Auto-save
        let timeout;
        reportEl.addEventListener('input', () => {
            clearTimeout(timeout);
            statusMsg.innerText = "Typing...";
            timeout = setTimeout(() => {
                localStorage.setItem(STORAGE_KEY, reportEl.innerText);
                localStorage.setItem(DATE_KEY, new Date().toDateString());
                statusMsg.innerText = "Saved";
            }, 800);
        });

        // Reset Button
        document.getElementById('resetBtn').addEventListener('click', () => {
            if(confirm("Are you sure? This will load fresh data from server.")) {
                localStorage.removeItem(STORAGE_KEY);
                localStorage.removeItem(DATE_KEY);
                
                // Force reload logic
                loadingOverlay.classList.remove('hidden');
                // Re-trigger listener essentially by just waiting for next update or reloading page
                // But simpler: just reload page to fetch fresh
                window.location.reload();
            }
        });

        // WhatsApp Share
        document.getElementById('whatsappShareBtn').addEventListener('click', () => {
            const text = reportEl.innerText;
            if(!text) return;
            const url = `whatsapp://send?text=${encodeURIComponent(text)}`;
            window.open(url, '_blank');
        });

        // Start
        loadData();

    </script>
</body>
</html>

