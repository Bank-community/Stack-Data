<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Stock Report Pro</title>
    
    <link rel="icon" type="image/png" href="https://i.ibb.co/ynyfk7Dr/20250827-104636.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        pre {
            white-space: pre-wrap;
            word-wrap: break-word;
            line-height: 1.6;
            font-family: inherit;
        }
        pre.editable {
            background-color: #fffbeb;
            border: 2px dashed #f59e0b;
            padding: 10px;
            border-radius: 8px;
            outline: none;
        }
        .loader {
            border: 3px solid #f3f3f3; border-radius: 50%; border-top: 3px solid #2563eb;
            width: 24px; height: 24px; animation: spin 1s linear infinite; margin: 0 auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .fade-in { animation: fadeIn 0.4s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="antialiased text-gray-800 h-screen flex flex-col">

    <!-- Login Screen -->
    <div id="login-screen" class="fixed inset-0 z-50 flex justify-center items-center bg-gray-100">
        <div class="w-full max-w-sm p-8 bg-white rounded-2xl shadow-xl text-center">
            <div class="bg-blue-50 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="ph-fill ph-lock-key text-3xl text-blue-600"></i>
            </div>
            <h2 class="text-2xl font-bold text-gray-900 mb-6">DTR Admin</h2>
            <input id="password" type="password" inputmode="numeric" class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 outline-none mb-4 text-center text-lg" placeholder="Enter Password">
            <p id="login-error" class="text-red-500 text-sm mb-4 hidden">Incorrect Password</p>
            <button id="login-button" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700 transition shadow-lg shadow-blue-500/30">Login</button>
        </div>
    </div>

    <!-- Main App Container -->
    <div id="app-container" class="container mx-auto max-w-3xl p-4 sm:p-6 hidden flex-grow">
        
        <!-- Header -->
        <header class="flex justify-between items-center mb-6">
            <div>
                <h1 class="text-2xl font-extrabold text-gray-900 flex items-center gap-2">
                    Daily DTR Report
                </h1>
                <p id="date-display" class="text-sm text-gray-500 font-bold mt-1">Loading...</p>
            </div>
            <button id="logout-btn" class="p-2 bg-white rounded-full shadow-sm text-gray-600 hover:text-red-600 transition" title="Logout">
                <i class="ph-bold ph-sign-out text-xl"></i>
            </button>
        </header>

        <!-- Controls Row -->
        <div class="bg-white p-3 rounded-xl shadow-sm border border-gray-200 mb-4 flex flex-wrap justify-between items-center gap-2">
            
            <!-- Left Side: Edit & Refresh -->
            <div class="flex gap-2">
                <button id="editBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg text-xs flex items-center gap-2 shadow-sm transition">
                    <i class="ph-bold ph-pencil-simple"></i> Edit Text
                </button>

                <button id="refreshBtn" class="bg-gray-100 hover:bg-gray-200 text-gray-700 font-bold py-2 px-4 rounded-lg text-xs flex items-center gap-2 shadow-sm transition">
                    <i class="ph-bold ph-arrows-clockwise"></i> Refresh Data
                </button>
            </div>

            <!-- Right Side: WhatsApp -->
            <button id="whatsappShareBtn" class="bg-[#25D366] hover:bg-[#20bd5a] text-white font-bold py-2 px-4 rounded-lg text-xs flex items-center gap-2 shadow-lg shadow-green-500/30 transition">
                <i class="ph-fill ph-whatsapp-logo text-lg"></i>
                Share on WhatsApp
            </button>
        </div>

        <div class="text-center mb-2 h-4">
             <span id="statusMsg" class="text-[10px] font-bold text-green-600 fade-in"></span>
        </div>

        <!-- Main Report Area -->
        <main class="bg-white rounded-2xl shadow-lg border border-gray-100 overflow-hidden relative min-h-[400px]">
            
            <!-- Loading Overlay -->
            <div id="loading-overlay" class="absolute inset-0 bg-white z-10 flex flex-col items-center justify-center">
                <div class="loader mb-2"></div>
                <p class="text-xs text-blue-600 font-bold">Generating Report...</p>
            </div>

            <!-- Content -->
            <div class="p-6 md:p-8 bg-gray-50 min-h-full">
                <pre id="reportContent" class="text-sm text-gray-800 font-mono whitespace-pre-wrap" contenteditable="false"></pre>
            </div>
        </main>

        <div class="text-center mt-6 text-xs text-gray-400 font-medium">
            Generated by Stock Manager Pro â€¢ Fixed: Stack 18 Removed (0.800 MT)
        </div>
    </div>

    <!-- Firebase Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAgzs3GqaafEHQSnEyZqrjQT0r_6jXMaGQ",
            authDomain: "re-store-7f2b3.firebaseapp.com",
            databaseURL: "https://re-store-7f2b3-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "re-store-7f2b3",
            storageBucket: "re-store-7f2b3.appspot.com",
            messagingSenderId: "774895588253",
            appId: "1:774895588253:web:dad6c0fed92bce7c39574"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);
        const userEmail = "jackprince79036@gmail.com";

        // DOM Elements
        const loginScreen = document.getElementById('login-screen');
        const appContainer = document.getElementById('app-container');
        const reportEl = document.getElementById('reportContent');
        const loadingOverlay = document.getElementById('loading-overlay');
        const dateDisplay = document.getElementById('date-display');
        const statusMsg = document.getElementById('statusMsg');
        
        // --- AUTH & LOGIN LOGIC ---
        
        onAuthStateChanged(auth, user => {
            if (user) {
                loginScreen.classList.add('hidden');
                appContainer.classList.remove('hidden');
                loadData();
            } else {
                loginScreen.classList.remove('hidden');
                appContainer.classList.add('hidden');
            }
        });

        document.getElementById('login-button').addEventListener('click', () => {
            const pass = document.getElementById('password').value;
            signInWithEmailAndPassword(auth, userEmail, pass).catch(() => {
                document.getElementById('login-error').classList.remove('hidden');
            });
        });

        document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));


        // --- PARTY IDENTIFICATION LOGIC ---
        function getPartyName(stackNum) {
            const s = parseInt(stackNum);
            
            // Logic
            if (s === 7) return "Mano Enterprises";
            if (s >= 1 && s <= 18) return "ITC"; 
            if ([22, 23, 25, 26, 27].includes(s)) return "Tyagi KRISHI KENDRA";
            if ([24, 28, 29, 30, 103, 105, 106].includes(s)) return "ITC";
            if ([101, 102, 104].includes(s)) return "SHIVSHANKAR Trading";
            
            return "General Party";
        }

        // --- REPORT GENERATION LOGIC ---
        function generateReport(transactions) {
            const todayStr = new Date().toLocaleDateString('en-GB');
            dateDisplay.innerText = todayStr;

            if (!transactions) return "No data available in database.";

            let groups = {};
            let grandTotalBags = 0;
            let grandTotalWeight = 0;

            const initGroup = (key, party, comm) => {
                if (!groups[key]) {
                    groups[key] = {
                        party: party,
                        commodity: comm,
                        netBags: 0,
                        netWeight: 0
                    };
                }
            };

            // Aggregation map
            let stackTotals = {};

            transactions.forEach(t => {
                // Safety check
                if (!t || !t.stackNumber) return;

                // --- NUCLEAR FILTER FOR STACK 18 ---
                const rawStack = t.stackNumber;
                
                // 1. Direct match (number or string)
                if (rawStack == 18 || rawStack == "18") return;
                if (rawStack == 501 || rawStack == "501") return;

                // 2. Integer parsed match (catches "018", "18.0", " 18 ")
                const cleanStackStr = String(rawStack).trim();
                const stackInt = parseInt(cleanStackStr);
                
                if (!isNaN(stackInt)) {
                    if (stackInt === 18) return;
                    if (stackInt === 501) return;
                }
                // -----------------------------------

                // Use the clean integer for grouping
                if (isNaN(stackInt)) return;

                if (!stackTotals[stackInt]) {
                    stackTotals[stackInt] = { 
                        inB: 0, inW: 0, outB: 0, outW: 0, 
                        party: getPartyName(stackInt), 
                        comm: t.commodity || 'Grain' 
                    };
                }

                const w = parseFloat(t.weight) || 0;
                const b = parseInt(t.bags) || 0;

                if (t.transactionType === 'inward') {
                    stackTotals[stackInt].inB += b;
                    stackTotals[stackInt].inW += w;
                } else {
                    stackTotals[stackInt].outB += b;
                    stackTotals[stackInt].outW += w;
                }
            });

            // Second pass: Group valid stacks
            Object.keys(stackTotals).forEach(sKey => {
                const s = parseInt(sKey);
                const data = stackTotals[s];
                
                // Final Check: Just to be absolutely sure
                if (s === 18 || s === 501) return;

                // Calc Net
                const netB = data.inB - data.outB;
                const netW = data.inW - data.outW;

                // CHECK: If Net <= 0, it means stack is empty/finished. Skip it.
                if (netB <= 0 || netW <= 0.001) return;

                // Group Key: Party + Commodity
                const groupKey = `${data.party}|${data.comm}`;
                
                initGroup(groupKey, data.party, data.comm);
                
                groups[groupKey].netBags += netB;
                groups[groupKey].netWeight += netW;
                
                grandTotalBags += netB;
                grandTotalWeight += netW;
            });

            // Step 2: Build Text Output
            let reportText = "";
            const sortedKeys = Object.keys(groups).sort(); 

            if (sortedKeys.length === 0) {
                return "All stacks are currently empty (Nil).";
            }

            sortedKeys.forEach(key => {
                const d = groups[key];
                const currentWeight = d.netWeight.toFixed(3);
                
                reportText += `ðŸ“¦ *STOCK SUMMARY:*
ðŸ“… Date: *${todayStr}*
ðŸ“ Subject: Daily Inward/Outward Report
ðŸ¢ *RUDRANSH WAREHOUSE BEGUSARAI*
ðŸ¤ Client: *${d.party.toUpperCase()}*
ðŸŒ¾ Commodity: *${d.commodity.toUpperCase()}*
ðŸ“¦ OPENING Bags :- *${d.netBags}*
âš–ï¸ OPENING MT   :- *${currentWeight}*
ðŸ“¥ INWARD Bags :-  *0*
âš–ï¸ INWARD MT    :-  *0*
ðŸ“¤ OUTWARD Bag:- *0*
âš–ï¸ OUTWARD MT :- *0*
ðŸ§µ MADE-UP Bag  :- *0*
ðŸ“¦ CLOSING Bag  :- *${d.netBags}*
âš–ï¸ CLOSING MT :-  *${currentWeight}*
ðŸ’° Funded Stock Details:
ðŸ“¦ Bags: 0
âš–ï¸ Quantity: 0
ðŸ¦ Bank: 0

----------------------------------------------------

`;
            });

            reportText += `ðŸ“Š *GRAND TOTAL SUMMARY*
ðŸ“¦ TOTAL Bags  :- *${grandTotalBags}*
âš–ï¸ TOTAL MT    :- *${grandTotalWeight.toFixed(3)}*`;

            return reportText;
        }

        // --- DATA FETCHING ---
        function loadData() {
            loadingOverlay.classList.remove('hidden');
            const txnRef = ref(db, 'transactions');
            
            onValue(txnRef, (snapshot) => {
                loadingOverlay.classList.add('hidden');
                const data = snapshot.val();
                if (data) {
                    const transactions = Object.values(data);
                    const freshText = generateReport(transactions);
                    reportEl.innerText = freshText;
                    statusMsg.innerText = "Live Data Synced";
                    setTimeout(() => statusMsg.innerText = "", 2000);
                } else {
                    reportEl.innerText = "Database Empty.";
                }
            }, (error) => {
                loadingOverlay.classList.add('hidden');
                reportEl.innerText = "Error fetching data: " + error.message;
            });
        }

        // --- BUTTON ACTIONS ---

        const editBtn = document.getElementById('editBtn');
        editBtn.addEventListener('click', () => {
            const isEditable = reportEl.getAttribute('contenteditable') === 'true';
            if (isEditable) {
                reportEl.setAttribute('contenteditable', 'false');
                reportEl.classList.remove('editable');
                editBtn.innerHTML = '<i class="ph-bold ph-pencil-simple"></i> Edit Text';
                editBtn.classList.replace('bg-green-600', 'bg-indigo-600');
                statusMsg.innerText = "Manual Edits Active (Will reset on refresh)";
            } else {
                reportEl.setAttribute('contenteditable', 'true');
                reportEl.classList.add('editable');
                reportEl.focus();
                editBtn.innerHTML = '<i class="ph-bold ph-check"></i> Save Changes';
                editBtn.classList.replace('bg-indigo-600', 'bg-green-600');
            }
        });

        document.getElementById('refreshBtn').addEventListener('click', () => {
            if(confirm("Refresh from Database? Any manual edits will be lost.")) {
                loadData();
            }
        });

        document.getElementById('whatsappShareBtn').addEventListener('click', () => {
            const text = reportEl.innerText;
            if(!text) return;
            const url = `whatsapp://send?text=${encodeURIComponent(text)}`;
            window.open(url, '_blank');
        });

    </script>
</body>
</html>


